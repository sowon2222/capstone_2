<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>백엔드 API 테스트</title>
</head>
<body>
  <h2>회원가입</h2>
  <input id="reg-username" placeholder="아이디" />
  <input id="reg-password" type="password" placeholder="비밀번호" />
  <button onclick="register()">회원가입</button>
  <div id="reg-result"></div>

  <h2>로그인</h2>
  <input id="login-username" placeholder="아이디" />
  <input id="login-password" type="password" placeholder="비밀번호" />
  <button onclick="login()">로그인</button>
  <div id="login-result"></div>

  <h2>강의자료 업로드</h2>
  <input id="pdf-file" type="file" />
  <button onclick="uploadPDF()">업로드</button>
  <div id="upload-result"></div>

  <h2>슬라이드 요약</h2>
  <input id="material-id" placeholder="material_id" />
  <input id="slide-number" placeholder="slide_number" />
  <button onclick="summarizeSlide()">슬라이드 요약</button>
  <div id="summary-result"></div>

  <h2>업로드된 자료 목록</h2>
  <button onclick="getArchiveList()">자료 목록 조회</button>
  <div id="archive-list-result"></div>

  <h2>특정 자료의 슬라이드 전체 요약</h2>
  <input id="archive-id" placeholder="material_id" />
  <button onclick="getSlides()">슬라이드 전체 요약 조회</button>
  <div id="slides-result"></div>

  <h2>전체 강의자료 요약</h2>
  <input id="summary-archive-id" placeholder="material_id" />
  <button onclick="summarizeMaterial()">전체 요약</button>
  <div id="material-summary-result"></div>

  <h2>진도율 저장</h2>
  <input id="progress-archive-id" placeholder="material_id" />
  <input id="progress-value" placeholder="progress(%)" />
  <button onclick="saveProgress()">진도율 저장</button>
  <div id="progress-result"></div>

  <h2>오늘의 학습 intensity</h2>
  <button onclick="getTodayIntensity()">오늘의 intensity</button>
  <div id="today-intensity-result"></div>

  <h2>학습 시간 기록</h2>
  <input id="study-duration" placeholder="duration(초)" />
  <button onclick="saveStudyTime()">학습 시간 기록</button>
  <div id="study-time-result"></div>

  <h2>문제 자동 생성 (GPT)</h2>
  <input id="gen-slide-id" placeholder="slide_id" />
  <input id="gen-keyword-id" placeholder="keyword_id" />
  <input id="gen-slide-title" placeholder="slide_title" />
  <input id="gen-concept-explanation" placeholder="concept_explanation" />
  <input id="gen-image-description" placeholder="image_description (optional)" />
  <input id="gen-keywords" placeholder="keywords (쉼표로 구분)" />
  <input id="gen-important-sentences" placeholder="중요문장 (쉼표로 구분)" />
  <input id="gen-slide-summary" placeholder="slide_summary" />
  <button onclick="generateQuizAuto()">문제 생성</button>
  <div id="quiz-generate-auto-result"></div>

  <h2>문제 제출/채점 (기출문제 풀기)</h2>
  <input id="submit-question-id" placeholder="question_id" />
  <input id="submit-answer" placeholder="내 답안" />
  <button onclick="submitQuizAnswer()">제출/채점</button>
  <div id="quiz-submit-result"></div>

  <script>
    let token = "";

    async function register() {
      const username = document.getElementById('reg-username').value;
      const password = document.getElementById('reg-password').value;
      const formData = new FormData();
      formData.append("username", username);
      formData.append("password", password);

      const res = await fetch('http://localhost:8000/register', {
        method: 'POST',
        body: formData
      });
      document.getElementById('reg-result').innerText = await res.text();
    }

    async function login() {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const formData = new FormData();
      formData.append("username", username);
      formData.append("password", password);

      const res = await fetch('http://localhost:8000/login', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();
      token = data.access_token || data.token || "";
      document.getElementById('login-result').innerText = JSON.stringify(data);
    }

    async function uploadPDF() {
      const file = document.getElementById('pdf-file').files[0];
      const formData = new FormData();
      formData.append('pdf', file);
      const res = await fetch('http://localhost:3000/api/upload', {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` },
        body: formData
      });
      document.getElementById('upload-result').innerText = await res.text();
    }

    async function summarizeSlide() {
      const materialId = document.getElementById('material-id').value;
      const slideNumber = document.getElementById('slide-number').value;
      const res = await fetch(`http://localhost:3000/archive/${materialId}/slide/${slideNumber}/summary`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      document.getElementById('summary-result').innerText = await res.text();
    }

    async function getArchiveList() {
      const res = await fetch('http://localhost:3000/archive/list', {
        headers: { Authorization: `Bearer ${token}` }
      });
      document.getElementById('archive-list-result').innerText = await res.text();
    }

    async function getSlides() {
      const archiveId = document.getElementById('archive-id').value;
      const res = await fetch(`http://localhost:3000/archive/${archiveId}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      document.getElementById('slides-result').innerText = await res.text();
    }

    async function summarizeMaterial() {
      const archiveId = document.getElementById('summary-archive-id').value;
      const res = await fetch(`http://localhost:3000/archive/${archiveId}/summary`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      document.getElementById('material-summary-result').innerText = await res.text();
    }

    async function saveProgress() {
      const archiveId = document.getElementById('progress-archive-id').value;
      const progress = document.getElementById('progress-value').value;
      const res = await fetch(`http://localhost:3000/archive/${archiveId}/progress`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ progress })
      });
      document.getElementById('progress-result').innerText = await res.text();
    }

    async function getTodayIntensity() {
      const res = await fetch('http://localhost:3000/api/study-intensity/today', {
        headers: { Authorization: `Bearer ${token}` }
      });
      document.getElementById('today-intensity-result').innerText = await res.text();
    }

    async function saveStudyTime() {
      const duration = document.getElementById('study-duration').value;
      const res = await fetch('http://localhost:3000/api/study-time', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ duration })
      });
      document.getElementById('study-time-result').innerText = await res.text();
    }

    async function generateQuizAuto() {
      const slide_id = document.getElementById('gen-slide-id').value;
      const keyword_id = document.getElementById('gen-keyword-id').value;
      const slide_title = document.getElementById('gen-slide-title').value;
      const concept_explanation = document.getElementById('gen-concept-explanation').value;
      const image_description = document.getElementById('gen-image-description').value;
      const keywords = document.getElementById('gen-keywords').value.split(',').map(s => s.trim());
      const important_sentences = document.getElementById('gen-important-sentences').value.split(',').map(s => s.trim());
      const slide_summary = document.getElementById('gen-slide-summary').value;

      const res = await fetch('http://localhost:8000/quiz/generate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          slide_id: Number(slide_id),
          keyword_id: Number(keyword_id),
          slide_title,
          concept_explanation,
          image_description: image_description || null,
          keywords,
          important_sentences,
          slide_summary
        })
      });
      document.getElementById('quiz-generate-auto-result').innerText = await res.text();
    }

    async function submitQuizAnswer() {
      const question_id = document.getElementById('submit-question-id').value;
      const answer = document.getElementById('submit-answer').value;

      const res = await fetch('http://localhost:8000/quiz/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          question_id,
          answer
        })
      });
      document.getElementById('quiz-submit-result').innerText = await res.text();
    }
  </script>
</body>
</html>
