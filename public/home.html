<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê°•ì˜ìë£Œ ìŠ¬ë¼ì´ë“œ ìš”ì•½</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .tab-btn { 
            padding: 10px 20px; 
            margin: 0 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            background: #1976d2; 
            color: white; 
        }
        .tab-btn.active { background: #4CAF50; }
        .tab-content { display: none; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-top: 20px; }
        .tab-content.active { display: block; }
        .material-item { 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .material-item:hover { background: #f5f5f5; }
        .slide-viewer { 
            border: 1px solid #4CAF50; 
            padding: 20px; 
            border-radius: 8px; 
            background: #f8fff8; 
            margin-top: 20px; 
        }
        .slide-nav { 
            margin-top: 20px; 
            text-align: center; 
        }
        .slide-nav button { 
            padding: 8px 16px; 
            margin: 0 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background: #4CAF50; 
            color: white; 
        }
        .slide-nav button:disabled { 
            background: #cccccc; 
            cursor: not-allowed; 
        }
        #uploadForm { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        #uploadForm input { 
            margin: 5px 0; 
            padding: 8px; 
            width: 100%; 
        }
        #uploadForm button { 
            padding: 10px 20px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <h1>ê°•ì˜ìë£Œ ìŠ¬ë¼ì´ë“œ ìš”ì•½</h1>
    <div>
        <button class="tab-btn active" id="tab-study-btn" onclick="showTab('study')">ê³µë¶€í•˜ê¸°</button>
        <button class="tab-btn" id="tab-archive-btn" onclick="showTab('archive')">ì•„ì¹´ì´ë¸Œ</button>
    </div>

    <!-- ê³µë¶€í•˜ê¸° íƒ­ -->
    <div id="tab-study" class="tab-content active">
        <form id="uploadForm" enctype="multipart/form-data">
            <input type="file" name="pdf" accept="application/pdf" required>
            <input type="text" name="material_name" placeholder="ê°•ì˜ìë£Œ ì´ë¦„" required>
            <button type="submit">ì—…ë¡œë“œ ë° ì‹œì‘í•˜ê¸°</button>
        </form>
        <div id="study-slide-viewer" style="display:none;">
            <div>
                <span id="slide-info"></span>
                <span id="progress-info"></span>
                <button id="study-prev-slide">ì´ì „</button>
                <button id="study-next-slide">ë‹¤ìŒ</button>
                <button id="study-close-slide">ë‹«ê¸°</button>
            </div>
            <div id="slide-summary"></div>
        </div>
    </div>

    <!-- ì•„ì¹´ì´ë¸Œ íƒ­ -->
    <div id="tab-archive" class="tab-content">
        <h2>ë‚´ ì—…ë¡œë“œ ê°•ì˜ìë£Œ</h2>
        <ul id="material-list"></ul>
        <div id="archive-slide-viewer" style="display:none;">
            <div id="archive-slide-content">
                <div>
                    <span id="slide-info">1 / 3</span>
                    <span id="progress-info">ì§„ë„ìœ¨: 0%</span>
                    <button id="prev-btn">ì´ì „</button>
                    <button id="next-btn">ë‹¤ìŒ</button>
                </div>
                <div id="slide-summary"></div>
            </div>
            <div class="slide-nav">
                <button id="archive-prev-slide" disabled>ì´ì „</button>
                <span id="archive-slide-count"></span>
                <button id="archive-next-slide">ë‹¤ìŒ</button>
                <button id="archive-close-slide">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="intensity-graph" style="margin:30px 0;"></div>

    <script>
        let authToken = localStorage.getItem('authToken') || '';
        let currentStudySlide = 1;
        let currentArchiveSlide = 1;
        let studyMaterialId = null;
        let archiveMaterialId = null;
        let totalSlides = 0;
        let progress = 0;
        let studyStartTime = null;

        // íƒ­ ì „í™˜
        function showTab(tab) {
            document.getElementById('tab-study').classList.remove('active');
            document.getElementById('tab-archive').classList.remove('active');
            document.getElementById('tab-study-btn').classList.remove('active');
            document.getElementById('tab-archive-btn').classList.remove('active');
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('tab-' + tab + '-btn').classList.add('active');
            if(tab === 'archive') loadMaterialList();
        }

        // ì—…ë¡œë“œ/ìš”ì•½ í¼
        document.getElementById('uploadForm').onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.material_id) {
                    studyMaterialId = data.material_id;
                    totalSlides = data.total_pages || 0;
                    currentStudySlide = 1;
                    document.getElementById('study-slide-viewer').style.display = 'block';
                    loadStudySlide();
                }
            } catch (e) {
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        };

        // ê³µë¶€í•˜ê¸° íƒ­: ìŠ¬ë¼ì´ë“œ ë¡œë“œ
        async function loadStudySlide() {
            await endSlideStudyAndSaveTime();
            const summaryDiv = document.getElementById('slide-summary');
            summaryDiv.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const res = await fetch(`/archive/${studyMaterialId}/slide/${currentStudySlide}/summary`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                const slide = data.slide;
                let extra = '';
                // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œì—ì„œë§Œ ì „ì²´ ìš”ì•½ ë²„íŠ¼ í‘œì‹œ
                if (currentStudySlide === totalSlides) {
                    extra = `<button id="show-overall-summary" style="margin-top:10px;">ì „ì²´ ìš”ì•½ ë³´ê¸°</button>
                    <div id="overall-summary-result" style="margin-top:10px;"></div>`;
                }
                summaryDiv.innerHTML = `
                    <div class="slide-viewer">
                        <h3>ìŠ¬ë¼ì´ë“œ ${slide.slide_number}</h3>
                        <b>ìŠ¬ë¼ì´ë“œ ì œëª©:</b> <span style="color:#1976d2;">${slide.slide_title || '-'}</span><br>
                        <b>ê°œë… ì„¤ëª…:</b> <span>${slide.concept_explanation || '-'}</span><br>
                        <b>ì£¼ìš” í‚¤ì›Œë“œ:</b> <span style="color:#388e3c;">${slide.main_keywords || '-'}</span><br>
                        <b>ì¤‘ìš”í•œ ë¬¸ì¥:</b>
                        <pre style="background:#f4f4f4;padding:10px;border-radius:4px;">${(slide.important_sentences || '-').replace(/^- /gm, '').replace(/\n/g, '\n')}</pre>
                        <b>ìŠ¬ë¼ì´ë“œ ì „ì²´ ìš”ì•½:</b>
                        <pre style="background:#e8f5e9;padding:10px;border-radius:4px;">${slide.summary || '-'}</pre>
                        ${extra}
                    </div>
                `;
                document.getElementById('slide-info').textContent = `${currentStudySlide} / ${totalSlides}`;
                progress = (currentStudySlide / totalSlides) * 100;
                document.getElementById('progress-info').textContent = `ì§„ë„ìœ¨: ${progress.toFixed(1)}%`;
                document.getElementById('study-prev-slide').disabled = currentStudySlide <= 1;
                document.getElementById('study-next-slide').disabled = currentStudySlide >= totalSlides;

                // ì „ì²´ ìš”ì•½ ë²„íŠ¼ ì´ë²¤íŠ¸
                if (currentStudySlide === totalSlides) {
                    document.getElementById('show-overall-summary').onclick = async function() {
                        const btn = this;
                        btn.disabled = true;
                        btn.textContent = 'ìš”ì•½ ì¤‘...';
                        const resultDiv = document.getElementById('overall-summary-result');
                        try {
                            const res = await fetch(`/archive/${studyMaterialId}/summary`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${authToken}` }
                            });
                            const data = await res.json();
                            if (data.summary) {
                                resultDiv.innerHTML = `<b>ì „ì²´ ìš”ì•½:</b><pre style='background:#fffde7;padding:10px;border-radius:4px;'>${data.summary}</pre>`;
                            } else {
                                resultDiv.innerHTML = 'ì „ì²´ ìš”ì•½ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                            }
                        } catch (e) {
                            resultDiv.innerHTML = 'ì „ì²´ ìš”ì•½ ì˜¤ë¥˜: ' + e.message;
                        }
                        btn.disabled = false;
                        btn.textContent = 'ì „ì²´ ìš”ì•½ ë³´ê¸°';
                    };
                }
            } catch (e) {
                summaryDiv.innerHTML = 'ì˜¤ë¥˜: ' + e.message;
            }
            updateProgress().then(() => {
                fetchAndRenderIntensityGraph();
            });
            startSlideStudy();
        }

        // ì•„ì¹´ì´ë¸Œ íƒ­: ìë£Œ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadMaterialList() {
            const ul = document.getElementById('material-list');
            ul.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const res = await fetch('/archive/list', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                ul.innerHTML = '';
                (data.materials || []).forEach(mat => {
                    const percent = Math.round(mat.progress || 0);
                    const li = document.createElement('li');
                    li.className = 'material-item';
                    li.innerHTML = `
                        <span>${mat.title} (${percent}% / ${mat.page}ìŠ¬ë¼ì´ë“œ)</span>
                        ${percent < 100
                            ? `<button onclick="continueStudy(${mat.material_id}, ${mat.page}, ${percent})">ì´ì–´ í•™ìŠµí•˜ê¸°</button>`
                            : `<span style="color:green;font-weight:bold;">í•™ìŠµ ì™„ë£Œ</span>`
                        }
                    `;
                    ul.appendChild(li);
                });
            } catch (e) {
                ul.innerHTML = '<li>ì˜¤ë¥˜: ' + e.message + '</li>';
            }
        }

        // ì•„ì¹´ì´ë¸Œ íƒ­: ìŠ¬ë¼ì´ë“œ ë³´ê¸° ì‹œì‘
        async function startArchive(materialId, total) {
            archiveMaterialId = materialId;
            currentArchiveSlide = 1;
            totalSlides = total;
            document.getElementById('archive-slide-viewer').style.display = 'block';
            loadArchiveSlide();
        }

        // ì•„ì¹´ì´ë¸Œ íƒ­: ìŠ¬ë¼ì´ë“œ ë¡œë“œ
        async function loadArchiveSlide() {
            const div = document.getElementById('archive-slide-content');
            div.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const res = await fetch(`/archive/${archiveMaterialId}/slide/${currentArchiveSlide}/summary`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                const slide = data.slide;
                div.innerHTML = `
                    <div class="slide-viewer">
                        <h3>ìŠ¬ë¼ì´ë“œ ${slide.slide_number}</h3>
                        <b>OCR ì›ë³¸:</b>
                        <pre style="background:#f4f4f4;padding:10px;border-radius:4px;">${slide.original_text}</pre>
                        <b>GPT ìš”ì•½:</b>
                        <pre style="background:#e8f5e9;padding:10px;border-radius:4px;">${slide.summary}</pre>
                    </div>
                `;
                document.getElementById('slide-info').textContent = `${currentArchiveSlide} / ${totalSlides}`;
                progress = (currentArchiveSlide / totalSlides) * 100;
                document.getElementById('progress-info').textContent = `ì§„ë„ìœ¨: ${progress.toFixed(1)}%`;
                document.getElementById('archive-prev-slide').disabled = currentArchiveSlide <= 1;
                document.getElementById('archive-next-slide').disabled = currentArchiveSlide >= totalSlides;
            } catch (e) {
                div.innerHTML = 'ì˜¤ë¥˜: ' + e.message;
            }
            updateProgress().then(() => {
                fetchAndRenderIntensityGraph();
            });
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        document.getElementById('study-prev-slide').onclick = function() {
            if (currentStudySlide > 1) {
                currentStudySlide--;
                loadStudySlide();
            }
        };
        document.getElementById('study-next-slide').onclick = function() {
            if (currentStudySlide < totalSlides) {
                currentStudySlide++;
                loadStudySlide();
            }
        };
        document.getElementById('archive-prev-slide').onclick = function() {
            if (currentArchiveSlide > 1) {
                currentArchiveSlide--;
                loadArchiveSlide();
            }
        };
        document.getElementById('archive-next-slide').onclick = function() {
            if (currentArchiveSlide < totalSlides) {
                currentArchiveSlide++;
                loadArchiveSlide();
            }
        };
        document.getElementById('study-close-slide').onclick = async function() {
            await endSlideStudyAndSaveTime();
            document.getElementById('study-slide-viewer').style.display = 'none';
            currentStudySlide = 1;
            studyStartTime = null;
            studyMaterialId = null;
            totalSlides = 0;
            progress = 0;
            await fetchAndRenderIntensityGraph();
        };
        document.getElementById('archive-close-slide').onclick = async function() {
            await endSlideStudyAndSaveTime();
            document.getElementById('archive-slide-viewer').style.display = 'none';
            currentArchiveSlide = 1;
            studyStartTime = null;
            archiveMaterialId = null;
            totalSlides = 0;
            progress = 0;
            await fetchAndRenderIntensityGraph();
        };

        // í˜ì´ì§€ ì§„ì… ì‹œ ê³µë¶€í•˜ê¸° íƒ­ í™œì„±í™”
        window.onload = function() {
            showTab('study');
            loadMonthlyIntensity();
        };

        async function loadMonthlyIntensity() {
            try {
                const res = await fetch('/api/study-intensity/month', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                drawIntensityGraph(data.data || []);
            } catch (error) {
                console.error('Error loading monthly intensity:', error);
            }
        }

        // ê°„ë‹¨í•œ ì”ë””(heatmap) ê·¸ë¦¬ê¸° ì˜ˆì‹œ
        function drawIntensityGraph(records) {
            const container = document.getElementById('intensity-graph');
            container.innerHTML = '<h3>ğŸŒ± ë‚˜ì˜ í•™ìŠµ ê·¸ë˜í”„ (ì ìˆ˜)</h3>';
            
            // ë‚ ì§œë³„ intensity_scoreë¥¼ ë§µìœ¼ë¡œ ë³€í™˜
            const map = {};
            records.forEach(r => {
                // ë‚ ì§œê°€ '2025-05-22T00:00:00.000Z' í˜•íƒœë©´ ì• 10ê¸€ìë§Œ ì‚¬ìš©
                const key = r.study_date.length > 10 ? r.study_date.slice(0, 10) : r.study_date;
                map[key] = r.intensity_score;
            });

            // ì´ë²ˆ ë‹¬ ë‚ ì§œ êµ¬í•˜ê¸°
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const score = map[dateStr] || 0;
                const color = score > 0 ? `rgba(76, 175, 80, ${Math.min(score/10, 1)})` : '#f5f5f5';
                
                html += `
                    <div style="
                        width:40px;
                        height:40px;
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        border:1px solid #ccc;
                        border-radius:5px;
                        background-color:${color};
                        font-size:12px;
                        color:${score > 0 ? 'white' : '#666'};
                    ">
                        <div>
                            <div style="font-weight:bold;">${score.toFixed(1)}</div>
                            <div style="font-size:10px;">${d}ì¼</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML += html;
        }

        function continueStudy(materialId, totalPages, progress) {
            archiveMaterialId = materialId;
            totalSlides = totalPages;
            // ì´ì–´ì„œ ë³¼ ìŠ¬ë¼ì´ë“œ ë²ˆí˜¸ ê³„ì‚° (ì§„ë„ìœ¨ì´ 33%ë©´ 2ë²ˆì§¸ ìŠ¬ë¼ì´ë“œë¶€í„°)
            let nextSlide = Math.floor((progress / 100) * totalPages) + 1;
            if (nextSlide > totalPages) nextSlide = totalPages;
            if (progress >= 100) nextSlide = totalPages;
            currentArchiveSlide = nextSlide;
            document.getElementById('archive-slide-viewer').style.display = 'block';
            loadArchiveSlide();
        }

        function updateProgress() {
            return new Promise((resolve, reject) => {
                // ì—¬ê¸°ì— ì§„ë„ìœ¨ ì—…ë°ì´íŠ¸ ë¡œì§ì„ êµ¬í˜„í•˜ê³ , ì™„ë£Œë˜ë©´ resolve í˜¸ì¶œ
                resolve();
            });
        }

        function fetchAndRenderIntensityGraph() {
            fetch('/api/study-intensity/month', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(res => res.json())
            .then(data => {
                drawIntensityGraph(data.data || []);
            })
            .catch(error => {
                console.error('Error fetching intensity graph:', error);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderIntensityGraph();
        });

        function startSlideStudy() {
            studyStartTime = Date.now();
        }

        async function endSlideStudyAndSaveTime() {
            if (studyStartTime) {
                const duration = Math.floor((Date.now() - studyStartTime) / 1000); // ì´ˆ ë‹¨ìœ„
                try {
                    // 1. í•™ìŠµ ì‹œê°„ ì €ì¥
                    await fetch('/api/study-time', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify({ duration })
                    });

                    // 2. ë°”ë¡œ intensity ì ìˆ˜ ê³„ì‚° ìš”ì²­
                    await fetch('/api/study-intensity/today', {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    // 3. ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                    await fetchAndRenderIntensityGraph();
                } catch (error) {
                    console.error('Error saving study time:', error);
                }
                studyStartTime = null;
            }
        }
    </script>
</body>
</html>
